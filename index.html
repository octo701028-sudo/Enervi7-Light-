<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Enervi7 PWAï¼ˆv6.3 é»è‘—æ€§ç‰ˆï¼‰</title>
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#6a00ff"/>
<style>
  :root{--bg:#0f0b1e;--panel:#141126;--accent:#6a00ff;--text:#ece8ff;--muted:#bdb6df;--ok:#22c55e;--warn:#f59e0b;--ring:#ffffff24}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{padding:18px 16px;background:linear-gradient(90deg,#6a00ff,#8b5cf6)}
  h1{margin:0;font-size:22px}
  .wrap{max-width:1000px;margin:16px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid #ffffff17;border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 10px 30px #00000040}
  .hint{color:var(--muted);font-size:13px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#ffffff1a;border:1px solid #ffffff2e;font-size:12px}
  .btn{background:var(--accent);border:none;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.ghost{background:#ffffff12;border:1px solid #ffffff26}
  .btn.flat{background:#ffffff14;border:1px solid #ffffff2a;color:#fff}
  details{background:#ffffff07;border:1px solid #ffffff1c;border-radius:10px;padding:10px;margin:10px 0}
  details[open]{outline:2px solid #ffffff1f}
  summary{cursor:pointer;font-weight:700}
  .pill{border:1px solid #ffffff24;border-radius:10px;padding:10px;margin:8px 0;background:#ffffff10}
  .q{padding:10px;border-radius:10px;background:#ffffff07;border:1px solid #ffffff1a;margin:10px 0}
  .q h4{margin:0 0 6px 0;font-size:15px}
  input[type=range]{width:100%}
  .scale-note{margin-top:6px;color:var(--muted);font-size:12px}
  canvas{max-width:100%;background:#0d0a1d;border-radius:12px;border:1px solid #ffffff14}
  .score-tag{padding:2px 8px;border-radius:8px;background:#ffffff14;font-size:12px;margin-left:6px}
  .good{background:#1b3e23;border:1px solid #2dd36f}
  .avg{background:#2a2544;border:1px solid #8b5cf6}
  .progress{height:10px;background:#ffffff14;border-radius:999px;overflow:hidden;border:1px solid #ffffff24}
  .bar{height:100%;background:linear-gradient(90deg,#6a00ff,#22c55e)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
  .medal{display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;border:1px solid var(--ring);background:#ffffff08;border-radius:12px;padding:12px}
  .medal .icon{width:48px;height:48px;border-radius:50%;background:#1e1638;border:2px solid #7c3aed;display:grid;place-items:center;box-shadow:0 0 0 4px #00000044}
  .medal.active .icon{background:#1b2b1f;border-color:#22c55e;box-shadow:0 0 0 4px #184a2d}
  .card-list{display:flex;gap:10px;flex-wrap:wrap}
  .soul{border:1px dashed var(--ring);border-radius:12px;padding:10px 12px;background:#ffffff06}
  .soul.lock{opacity:.6}
</style>
</head>
<body>
<header>
  <h1>Enervi7ï¼ˆv6.3 é»è‘—æ€§ç‰ˆï¼‰</h1>
  <div class="hint">å«ï¼š14 é¡Œé‡è¡¨ï¼‹é›·é”åœ–ï¼‹æœ€ä½åˆ†è‡ªå‹•å±•é–‹ï¼å‘¢å–ƒç¥è«­ä¸é‡è¤‡ï¼ä»Šæ—¥å»ºè­°ç²¾æ²¹ï¼é€£çºŒæ—…ç¨‹æŒ‘æˆ°ï¼‹å¾½ç« ï¼‹éš±è—éˆé­‚å¡ã€‚</div>
</header>

<div class="wrap">

  <!-- é‡è¡¨ + é›·é” -->
  <section class="card" id="survey">
    <div class="row" style="justify-content:space-between;align-items:end">
      <h2>ğŸ§­ 14 é¡Œé‡è¡¨</h2>
      <div class="hint">0 = å®Œå…¨ä¸ç¬¦åˆï¼å¹¾ä¹æ²’æœ‰ã€€|ã€€10 = éå¸¸ç¬¦åˆï¼å¹¾ä¹ç¸½æ˜¯</div>
    </div>
    <div id="qlist"></div>
    <div class="row" style="gap:10px;margin-top:10px">
      <button class="btn" id="gen">ç”Ÿæˆèƒ½é‡åœ–</button>
      <button class="btn ghost" id="reset">å…¨éƒ¨é‡ç½®</button>
    </div>
    <div id="result" style="display:none;margin-top:14px">
      <div class="pill" id="summary">â€”</div>
      <canvas id="radar" width="720" height="520"></canvas>
    </div>
  </section>

  <!-- å³æ™‚å›é¥‹ -->
  <section class="card">
    <h2>ğŸ´ å‘¢å–ƒç¥è«­ï¼ˆWhispering Oracleï¼‰</h2>
    <div id="oracle" class="pill">â€”</div>
    <button id="draw" class="btn">æŠ½ä¸€å¼µ</button>
    <div class="hint">åŒä¸€å¤©åƒ…é¡¯ç¤ºä¸€å¼µï¼›éš”å¤©è‡ªå‹•åˆ·æ–°ã€‚</div>
  </section>

  <section class="card">
    <h2>ğŸª” ä»Šæ—¥å»ºè­°ç²¾æ²¹</h2>
    <div id="oil" class="pill">â€”</div>
    <button id="reroll" class="btn" title="ä»Šå¤©åªè¨˜éŒ„ç¬¬ä¸€æ¬¡ï¼Œé‡æ–°æŠ½åƒ…ç¤ºæ„">æ›ä¸€æ¬¾ï¼ˆç¤ºæ„ï¼‰</button>
    <div class="hint">é¡¯ç¤ºï¼šè‹±æ–‡åç¨±ï¼ˆå®˜æ–¹ä¸­æ–‡ï¼‰ï¼‹èƒ½é‡æè¿°ï¼ˆä¾†è‡ª <code>yl_blends.json</code>ï¼‰ã€‚</div>
  </section>

  <!-- ä¸ƒéšè³‡è¨Šå¡ -->
  <section class="card" id="cards">
    <h2>ğŸŒˆ ä¸ƒéšè³‡è¨Šå¡ï¼ˆæ¸¬é©—å¾Œè‡ªå‹•å±•é–‹æœ€ä½åˆ†ï¼‰</h2>
    <div id="cardsHost"></div>
  </section>

  <!-- A. é€£çºŒæ—…ç¨‹æŒ‘æˆ° -->
  <section class="card" id="journey">
    <h2>ğŸŒ€ é€£çºŒæ—…ç¨‹æŒ‘æˆ°</h2>
    <div class="row">
      <button class="btn flat" data-plan="7">å•Ÿå‹• 7 æ—¥èƒ½é‡æŒ‘æˆ°</button>
      <button class="btn flat" data-plan="21">å•Ÿå‹• 21 æ—¥éˆé­‚è½‰åŒ–</button>
      <button class="btn flat" data-plan="310">å•Ÿå‹• 310 æ—¥é¡¯åŒ–æ—¥è¨˜</button>
    </div>
    <div class="pill" id="planInfo">å°šæœªå•Ÿå‹•æŒ‘æˆ°ã€‚</div>
    <div class="progress"><div class="bar" id="planBar" style="width:0%"></div></div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="checkin">ä»Šæ—¥æ‰“å¡</button>
      <span class="hint" id="streakInfo">é€£çºŒ 0 å¤©</span>
    </div>
  </section>

  <!-- B. æˆå°±å¾½ç«  -->
  <section class="card" id="badges">
    <h2>ğŸ… æˆå°±å¾½ç« </h2>
    <div class="grid">
      <div class="medal" id="b7"><div class="icon">7</div><div>é€£çºŒ 7 æ—¥</div></div>
      <div class="medal" id="b21"><div class="icon">21</div><div>å…‰ä¹‹è¡Œè€…</div></div>
      <div class="medal" id="b30"><div class="icon">30</div><div>éˆé­‚æ•´åˆå¡</div></div>
    </div>
  </section>

  <!-- C. éš±è—å¡ç‰Œ -->
  <section class="card" id="hidden">
    <h2>ğŸ´ éš±è—éˆé­‚å¡ï¼ˆæ¯æ»¿ 7 æ—¥è§£é– 1 å¼µï¼‰</h2>
    <div class="hint" id="hiddenHint">å·²è§£é– 0 / 33 å¼µ</div>
    <div class="card-list" id="hiddenList"></div>
  </section>

</div>

<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}

// ========= é‡è¡¨è³‡æ–™ =========
const PHASES = [
  { key:'ç™½',   name:'èƒ½é‡è¦ºçŸ¥',   color:'#ffffff' },
  { key:'è—',   name:'ç©©å®šèˆ‡æ·¨åŒ–', color:'#60a5fa' },
  { key:'æ©™',   name:'èƒ½é‡æµå‹•',   color:'#fb923c' },
  { key:'é»ƒ',   name:'å…§åœ¨åŠ›é‡',   color:'#facc15' },
  { key:'ç¶ ',   name:'å…±æŒ¯èˆ‡é€£çµ', color:'#22c55e' },
  { key:'é›è—', name:'æ„è­˜æ“´å±•',   color:'#818cf8' },
  { key:'ç´«',   name:'éˆé­‚æ•´åˆ',   color:'#a78bfa' },
];

const QUESTIONS = [
  {phase:0, text:'æˆ‘èƒ½æ¸…æ¥šè¦ºå¯Ÿè‡ªå·±æ­¤åˆ»çš„èº«å¿ƒç‹€æ…‹ã€‚'},
  {phase:0, text:'æˆ‘èƒ½åœ¨æ··äº‚æ™‚ï¼Œè¿…é€ŸæŠŠæ³¨æ„åŠ›å¸¶å›ç•¶ä¸‹ã€‚'},
  {phase:1, text:'é¢å°å£“åŠ›æˆ–è¡çªæ™‚ï¼Œæˆ‘èƒ½ä¿æŒå†·éœä¸å¤±è¡¡ã€‚'},
  {phase:1, text:'æˆ‘èƒ½æœ‰æ•ˆåœ°é‡‹æ”¾ç´¯ç©çš„è² é¢æƒ…ç·’èˆ‡é›œå¿µã€‚'},
  {phase:2, text:'æˆ‘å¸¸æ„Ÿè¦ºéˆæ„Ÿï¼æƒ…æ„Ÿåœ¨é«”å…§è‡ªç„¶æµå‹•ã€‚'},
  {phase:2, text:'æˆ‘èƒ½é †å‹¢èª¿æ•´æ­¥èª¿ï¼Œä¸åƒµç¡¬æˆ–å¡ä½ã€‚'},
  {phase:3, text:'åšæ±ºå®šæ™‚ï¼Œæˆ‘èƒ½å …å®šåœ°é¸æ“‡å°è‡ªå·±çœŸçš„å¥½çš„äº‹ã€‚'},
  {phase:3, text:'é‡åˆ°æŒ‘æˆ°ï¼Œæˆ‘ä»èƒ½ç›¸ä¿¡è‡ªå·±ä¸¦å¾€å‰ä¸€æ­¥ã€‚'},
  {phase:4, text:'æˆ‘èƒ½çœŸèª è¡¨é”ï¼Œä¹Ÿæ¨‚æ–¼å‚¾è½ä»–äººã€‚'},
  {phase:4, text:'æˆ‘èƒ½æ„Ÿåˆ°è‡ªå·±èˆ‡ä»–äººã€èˆ‡ä¸–ç•Œæ˜¯é€£çµçš„ã€‚'},
  {phase:5, text:'æˆ‘ä¿¡ä»»ç›´è¦ºï¼Œä¸”èƒ½å¾ä¸­ç²å¾—æœ‰ç”¨çš„æŒ‡å¼•ã€‚'},
  {phase:5, text:'æˆ‘èƒ½å¾æ—¥å¸¸äº‹ä»¶çœ‹è¦‹æ›´æ·±çš„æ´è¦‹èˆ‡æ„ç¾©ã€‚'},
  {phase:6, text:'æˆ‘èƒ½æŠŠéå»çš„ç¶“é©—æ•´åˆæˆåŠ›é‡ï¼Œè€Œä¸æ˜¯æ·é–ã€‚'},
  {phase:6, text:'æˆ‘å¸¸æ„Ÿåˆ°è‡ªå·±å®Œæ•´ã€å°ç”Ÿå‘½æ–¹å‘è¸å¯¦å®‰å¿ƒã€‚'},
];

const CARD_TIPS = [
  { key:'ç™½',   keywords:'è¦ºçŸ¥ã€æ¸…æ˜ã€é¢å°ç•¶ä¸‹',  actions:['å¯«ä¸‰å¥ã€Œæ­¤åˆ»æˆ‘çœŸå¯¦çš„æ„Ÿå—æ˜¯â€¦ã€','3 åˆ†é˜è…¹å¼å‘¼å¸ï¼ˆ4-4-6ï¼‰','æ¨™è¨» 1 å€‹å¿µé ­ï¼šäº‹å¯¦æˆ–è§£è®€ï¼Ÿ'] },
  { key:'è—',   keywords:'ç©©å®šã€é‡‹æ”¾ã€ç•Œç·š',      actions:['å¯«ä¸‹æœ€å›°æ“¾ä½ çš„ 1 ä»¶äº‹ï¼ˆå¯æ§/ä¸å¯æ§ï¼‰','3 åˆ†é˜èº«é«”æƒæ','ç”¨æ°´æˆ–ç²¾æ²¹åš 3 åˆ†é˜æ·¨åŒ–'] },
  { key:'æ©™',   keywords:'æµå‹•ã€å‰µé€ ã€æ„Ÿå—',      actions:['ä»Šå¤©åšä¸€ä»¶ 3 åˆ†é˜çš„å°å‰µä½œ','åˆ—å‡º 1 ä»¶è®“ä½ å–œæ‚…çš„å°äº‹','è®“èº«é«”éš¨éŸ³æ¨‚æ“ºå‹• 1 åˆ†é˜'] },
  { key:'é»ƒ',   keywords:'åŠ›é‡ã€é¸æ“‡ã€ç•Œå®š',      actions:['æŠŠç›®æ¨™æ‹†æˆã€Œ10 åˆ†é˜å¯å®Œæˆçš„ä¸€æ­¥ã€','åšä¸€ä»¶æå‡æŒæ§æ„Ÿçš„å°äº‹','å°ä¸€ä»¶äº‹èªªã€Œä¸ã€'] },
  { key:'ç¶ ',   keywords:'é€£çµã€å…±æŒ¯ã€æ”¯æŒ',      actions:['çµ¦ä¸€å€‹äººä¸€å¥çœŸèª è‚¯å®š','5 åˆ†é˜æ·±åº¦å‚¾è½','å¯«ä¸‹ä¸€ä»¶æƒ³æ„Ÿè¬çš„äººäº‹ç‰©'] },
  { key:'é›è—', keywords:'æ´è¦‹ã€ç›´è¦ºã€æ“´å±•',      actions:['é–‰çœ¼ 60 ç§’ï¼šå…§åœ¨æƒ³å°æˆ‘èªªä»€éº¼ï¼Ÿ','å¯«ä¸‹ä¸€å€‹ä»Šå¤©çš„åŒæ­¥å·§åˆ','æŠŠå›°æ“¾æ› 1 å€‹æ›´é«˜è¦–è§’'] },
  { key:'ç´«',   keywords:'æ•´åˆã€è‡£æœã€å®Œæ•´',      actions:['åˆ—å‡º 1 ä»¶å·²å®Œæˆä¸¦è‡´æ„è‡ªå·±','å¯«ä¸‹å¯æ”¾ä¸‹çš„ä¸€ä»¶äº‹','éœå 2 åˆ†é˜ï¼Œè§€æƒ³å…§åœ¨åˆä¸€'] },
];

// ========= æ¸²æŸ“ 14 é¡Œ =========
const qHost = document.getElementById('qlist');
QUESTIONS.forEach((q, i)=>{
  const p = PHASES[q.phase];
  const el = document.createElement('div');
  el.className='q';
  el.innerHTML = `
    <h4>${i+1}. <span class="badge">${p.key}ï½œ${p.name}</span></h4>
    <div>${q.text}</div>
    <div class="row" style="gap:10px;margin-top:8px">
      <input type="range" min="0" max="10" step="1" value="5" id="r${i}"/>
      <span class="score-tag avg" id="v${i}">5</span>
    </div>
    <div class="scale-note">0 = å®Œå…¨ä¸ç¬¦åˆã€€ï¼ã€€10 = éå¸¸ç¬¦åˆ</div>
  `;
  qHost.appendChild(el);
  el.querySelector(`#r${i}`).addEventListener('input', e=>{
    el.querySelector(`#v${i}`).textContent = e.target.value;
  });
});

document.getElementById('reset').onclick=()=>{
  QUESTIONS.forEach((_,i)=>{
    document.getElementById(`r${i}`).value=5;
    document.getElementById(`v${i}`).textContent=5;
  });
  document.getElementById('result').style.display='none';
};

function computePhaseAverages(){
  const sums = Array(PHASES.length).fill(0);
  const counts = Array(PHASES.length).fill(0);
  QUESTIONS.forEach((q,i)=>{
    const v = +document.getElementById(`r${i}`).value;
    sums[q.phase]+=v; counts[q.phase]+=1;
  });
  return sums.map((s,i)=> (counts[i]? s/counts[i] : 0));
}

function drawRadar(values){
  const cv = document.getElementById('radar');
  const ctx = cv.getContext('2d');
  const W=cv.width, H=cv.height;
  ctx.clearRect(0,0,W,H);
  const cx=W/2, cy=H/2+10;
  const radius = Math.min(W,H)*0.35;
  const steps = 5;
  ctx.save(); ctx.translate(cx,cy);
  ctx.strokeStyle = '#ffffff22';
  for(let s=1;s<=steps;s++){ ctx.beginPath(); ctx.arc(0,0,radius*s/steps,0,Math.PI*2); ctx.stroke(); }
  for(let i=0;i<PHASES.length;i++){ const a = -Math.PI/2 + i*(Math.PI*2/PHASES.length); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(a)*radius, Math.sin(a)*radius); ctx.stroke(); }
  ctx.beginPath();
  values.forEach((v,i)=>{ const r=radius*(v/10), a=-Math.PI/2+i*(Math.PI*2/PHASES.length); const x=Math.cos(a)*r, y=Math.sin(a)*r; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.closePath(); ctx.fillStyle='#8b5cf680'; ctx.strokeStyle='#a78bfa'; ctx.lineWidth=2; ctx.fill(); ctx.stroke();
  ctx.fillStyle='#bdb6df'; ctx.font='14px system-ui';
  values.forEach((v,i)=>{ const a=-Math.PI/2+i*(Math.PI*2/PHASES.length); const x=Math.cos(a)*(radius+24), y=Math.sin(a)*(radius+24); ctx.fillText(`${PHASES[i].key}`, x-8, y+5); });
  ctx.restore();
}

document.getElementById('gen').onclick=()=>{
  const avgs = computePhaseAverages();
  const maxI = avgs.indexOf(Math.max(...avgs));
  const minI = avgs.indexOf(Math.min(...avgs));
  const summary = `æœ€é«˜ï¼š${PHASES[maxI].key}ï½œ${PHASES[maxI].name} ${avgs[maxI].toFixed(1)}ã€€ï¼ã€€æœ€ä½ï¼š${PHASES[minI].key}ï½œ${PHASES[minI].name} ${avgs[minI].toFixed(1)}`;
  document.getElementById('summary').textContent = summary;
  document.getElementById('result').style.display='block';
  drawRadar(avgs);
  renderCards(avgs, minI);
  document.getElementById('result').scrollIntoView({behavior:'smooth',block:'center'});
};

function renderCards(avgs, minIndex){
  const host = document.getElementById('cardsHost');
  host.innerHTML = '';
  PHASES.forEach((p,idx)=>{
    const cfg = CARD_TIPS[idx];
    const score = avgs ? avgs[idx].toFixed(1) : '-';
    const state = !avgs ? '' : (avgs[idx] >= 7 ? '<span class="score-tag good">å„ªå‹¢</span>' : '<span class="score-tag">è§€ç…§</span>');
    const det = document.createElement('details');
    if(avgs && idx===minIndex) det.open = true; // è‡ªå‹•å±•é–‹æœ€ä½åˆ†
    det.innerHTML = `
      <summary>${p.key}ï½œ${p.name}ã€€<span class="score-tag avg">${score}</span> ${state}</summary>
      <div class="pill"><b>é—œéµå­—ï¼š</b>${cfg.keywords}</div>
      <div class="pill"><b>è¡Œå‹•å»ºè­°ï¼š</b><ul style="margin:6px 0 0 18px">${cfg.actions.map(a=>`<li>${a}</li>`).join('')}</ul></div>`;
    host.appendChild(det);
  });
}
renderCards(null,null);

// ========= ç¥è«­ + ä»Šæ—¥ç²¾æ²¹ =========
const ORA_KEY='e7_oracle_v6_3';
const OIL_KEY='e7_oil_v6_3';
function today(){return new Date().toISOString().slice(0,10);}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
async function loadJSON(p){const r=await fetch(p).catch(()=>null);return (r && r.ok)? r.json() : null}

const ORA_FALLBACK=[{"id":1,"title":"æ­¸ä¾†","poem":"ä½ ä¸æ˜¯å›é ­ï¼Œè€Œæ˜¯ç™¼ç¾ï¼šä½ ä¸€ç›´éƒ½åœ¨ã€‚","action":"ä»Šå¤©ï¼Œå°è‡ªå·±èªªï¼šæˆ‘å·²ç¶“å›ä¾†äº†ã€‚"},{"id":2,"title":"æˆç‚º","poem":"ä½ æ²’æœ‰è®Šå¾—æ›´å¥½ï¼Œåªæ˜¯è®Šå¾—æ›´çœŸã€‚","action":"å…è¨±è‡ªå·±å‡ºç¾ï¼Œå“ªæ€•åªæ˜¯ 1 åˆ†é˜ã€‚"},{"id":3,"title":"éœé»˜","poem":"æ²‰é»˜ä¸æ˜¯ç©ºç™½ï¼Œæ˜¯èªè¨€ä¹‹å‰çš„å®Œæ•´ã€‚","action":"æŠŠæ‰‹æ”¾åœ¨å¿ƒå£ï¼Œå‘¼å¸ 60 ç§’ã€‚"}];
const OIL_FALLBACK=[{"name":"Peace & Calming","zh_name":"èˆ’éœ","description":"å®‰æ’«æƒ…ç·’ï¼Œå¸¶ä¾†æ·±å±¤å¯§çœ èˆ‡å…§åœ¨å¹³éœã€‚"},{"name":"Harmony","zh_name":"å’Œè«§ï¼ˆæ¨‚èï¼‰","description":"å¹³è¡¡èº«å¿ƒèƒ½é‡ï¼Œä¿ƒé€²å…§åœ¨èˆ‡é—œä¿‚çš„å”èª¿é€£çµã€‚"},{"name":"Forgiveness","zh_name":"å¯¬æ•","description":"é‡‹æ”¾éå»çµï¼Œå¸¶ä¾†å¿ƒéˆçš„è‡ªç”±èˆ‡ç™‚ç™’ã€‚"}];

function setOracleForToday(card){localStorage.setItem(ORA_KEY, JSON.stringify({date:today(), id:card.id}))}
function getOracleFromStorage(){try{return JSON.parse(localStorage.getItem(ORA_KEY))}catch(e){return null}}
async function showOracle(){
  let deck = await loadJSON('oracle_whispering.json') || ORA_FALLBACK;
  let saved=getOracleFromStorage(), card;
  if(!saved || saved.date!==today()){ card=pick(deck); setOracleForToday(card); } else { card=deck.find(x=>x.id===saved.id) || pick(deck); }
  document.getElementById('oracle').innerHTML = `<b>ã€Œ${card.title}ã€</b><div class="hint">${card.poem}</div><div>è¡Œå‹•ï¼š${card.action}</div>`;
}
document.getElementById('draw').addEventListener('click', showOracle);

function setOilForToday(item){localStorage.setItem(OIL_KEY, JSON.stringify({date:today(), name:item.name}))}
function getOilFromStorage(){try{return JSON.parse(localStorage.getItem(OIL_KEY))}catch(e){return null}}
async function showOil(forceNew=false){
  let oils = await loadJSON('yl_blends.json') || OIL_FALLBACK;
  let saved=getOilFromStorage(), item;
  if(forceNew || !saved || saved.date!==today()){ item=pick(oils); setOilForToday(item); } else { item=oils.find(x=>x.name===saved.name) || pick(oils); }
  document.getElementById('oil').innerHTML = `<b>${item.name}ï¼ˆ${item.zh_name}ï¼‰</b><div class="hint">${item.description}</div>`;
}
document.getElementById('reroll').addEventListener('click', ()=>showOil(true));
showOracle(); showOil();

// ========= A/B/C é»è‘—æ€§é‚è¼¯ =========
const JOURNEY_KEY='e7_journey'; // {plan:7|21|310, start:'YYYY-MM-DD'}
const STREAK_KEY='e7_streak';   // {last:'YYYY-MM-DD', count:n, total:n}
const HIDDEN_KEY='e7_hidden';   // {unlocked:n}

function loadLS(k,def){try{const v=JSON.parse(localStorage.getItem(k));return v??def}catch(e){return def}}
function saveLS(k,v){localStorage.setItem(k,JSON.stringify(v))}

function setPlan(days){
  const j={plan:days, start:today()}; saveLS(JOURNEY_KEY,j);
  updatePlanUI();
}
function daysSince(a,b){ // diff between YYYY-MM-DD
  const d1=new Date(a+"T00:00:00"), d2=new Date(b+"T00:00:00"); return Math.round((d2-d1)/86400000);
}
function planProgress(){
  const j=loadLS(JOURNEY_KEY,null); if(!j) return {text:'å°šæœªå•Ÿå‹•æŒ‘æˆ°ã€‚',pct:0,days:0,plan:0};
  const d=daysSince(j.start,today())+1; // ç¬¬ä¸€å¤©ç®— 1
  const pct=Math.max(0,Math.min(100,Math.round(d/j.plan*100)));
  return {text:`é€²è¡Œç¬¬ ${d} å¤©ï¼å…± ${j.plan} å¤©`,pct,days:d,plan:j.plan};
}
function updatePlanUI(){
  const p=planProgress();
  document.getElementById('planInfo').textContent=p.text;
  document.getElementById('planBar').style.width=p.pct+'%';
}
document.querySelectorAll('#journey [data-plan]').forEach(b=>b.addEventListener('click',()=>setPlan(+b.dataset.plan)));

function checkinToday(){
  let s=loadLS(STREAK_KEY,{last:null,count:0,total:0});
  if(s.last===today()){ alert('ä»Šå¤©å·²æ‰“å¡ âœ…'); return; }
  if(s.last && daysSince(s.last,today())===1){ s.count+=1; } else { s.count=1; }
  s.total+=1; s.last=today(); saveLS(STREAK_KEY,s);
  // éš±è—å¡ï¼šæ¯æ»¿ 7 æ—¥è§£é–
  if(s.total%7===0){ let h=loadLS(HIDDEN_KEY,{unlocked:0}); if(h.unlocked<33){h.unlocked++; saveLS(HIDDEN_KEY,h);} }
  updateStreakUI(); updateBadges(); renderHidden();
}
function updateStreakUI(){
  const s=loadLS(STREAK_KEY,{count:0}); document.getElementById('streakInfo').textContent=`é€£çºŒ ${s.count} å¤©`;
}
document.getElementById('checkin').addEventListener('click', checkinToday);

function updateBadges(){
  const s=loadLS(STREAK_KEY,{count:0});
  document.getElementById('b7').classList.toggle('active', s.count>=7);
  document.getElementById('b21').classList.toggle('active', s.count>=21);
  document.getElementById('b30').classList.toggle('active', s.count>=30);
}
function renderHidden(){
  const h=loadLS(HIDDEN_KEY,{unlocked:0});
  document.getElementById('hiddenHint').textContent=`å·²è§£é– ${h.unlocked} / 33 å¼µ`;
  const host=document.getElementById('hiddenList'); host.innerHTML='';
  for(let i=1;i<=33;i++){
    const d=document.createElement('div'); d.className='soul'+(i<=h.unlocked?'':' lock');
    d.innerHTML=`#${i}ã€€${i<=h.unlocked? 'éˆé­‚å‘¢å–ƒï¼šä½ æ¯”è‡ªå·±ä»¥ç‚ºçš„é‚„é è¿‘ã€‚':'é–å®šä¸­'}`;
    host.appendChild(d);
  }
}

updatePlanUI(); updateStreakUI(); updateBadges(); renderHidden();
</script>
</body>
</html>