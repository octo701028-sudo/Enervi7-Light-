
<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Enervi7 v7.0</title>
<link rel="manifest" href="manifest.json"><meta name="theme-color" content="#6a00ff">
<style>
:root{--bg:#0f0b1e;--panel:#141126;--accent:#6a00ff;--text:#ece8ff;--muted:#bdb6df}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
header{padding:18px 16px;background:linear-gradient(90deg,#6a00ff,#8b5cf6)}
h1{margin:0;font-size:22px}.hint{color:var(--muted);font-size:13px}
.wrap{max-width:960px;margin:16px auto;padding:0 14px}
.card{background:var(--panel);border:1px solid #ffffff20;border-radius:14px;padding:14px;margin:12px 0}
.q{padding:8px 10px;border:1px solid #ffffff22;border-radius:10px;margin:8px 0;background:#ffffff08}
.btn{background:var(--accent);border:none;color:#fff;border-radius:10px;padding:10px 14px;font-weight:600}
.badges{display:flex;gap:10px}.badge{width:60px;height:60px;border-radius:50%;display:grid;place-items:center;border:2px solid #ffffff33}
.badge.on{background:#10b98122;border-color:#10b981}
.score{padding:3px 8px;border:1px solid #ffffff2a;border-radius:8px;background:#ffffff14}
.pill{display:inline-block;background:#ffffff12;border:1px solid #ffffff24;border-radius:999px;padding:4px 10px;margin:2px;font-size:12px}
.small{font-size:12px;color:#bdb6df}
canvas{max-width:100%;background:#0d0a1d;border:1px solid #ffffff18;border-radius:12px}
</style></head><body>
<header><h1>Enervi7 v7.0</h1><div class="hint">14 題＋雷達＋最低分補強＋呢喃神諭＋今日精油＋旅程徽章＋隱藏卡</div></header>
<div class="wrap">
<section class="card"><h2>🌀 旅程 & 徽章</h2>
  <div>連續：<b id="streak">0</b> ｜ 累積：<b id="total">0</b></div>
  <div class="badges" style="margin-top:8px">
    <div id="b7" class="badge">7</div><div id="b21" class="badge">21</div><div id="b30" class="badge">30</div>
  </div>
  <button class="btn" id="done">✅ 完成今日</button> <span id="unlock" class="small"></span>
</section>

<section class="card"><h2>🧭 14 題量表（0–10）</h2><div id="qs"></div>
  <button class="btn" id="go">生成能量圖</button>
  <div id="res" style="display:none;margin-top:10px">
    <div id="sum" class="hint">—</div>
    <canvas id="radar" width="740" height="500"></canvas>
  </div>
</section>

<section class="card" id="lowestPanel" style="display:none"><h2>🧩 瓶頸補強卡</h2><div id="stageTips"></div></section>

<section class="card"><h2>🎴 呢喃神諭</h2><div id="oracle" class="hint">—</div><button class="btn" id="draw">抽一張</button></section>

<section class="card"><h2>🪔 今日建議精油</h2><div id="oil" class="hint">—</div><button class="btn" id="reroll">換一款</button></section>

<section class="card"><h2>🌈 七階關鍵字＋行動</h2><div id="stageList"></div></section>

<section class="card"><h2>🗝️ 已解鎖的隱藏卡</h2><div id="unlocked" class="small">尚未解鎖。</div></section>
</div>

<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}
const P=[{k:'白',n:'覺察'},{k:'藍',n:'釋放'},{k:'橙',n:'信任'},{k:'黃',n:'行動'},{k:'綠',n:'流動'},{k:'靛藍',n:'共鳴'},{k:'紫',n:'整合'}];
const Q=[
{p:0,t:'我能清楚覺察自己此刻的身心狀態。'},{p:0,t:'我能在混亂時，迅速把注意力帶回當下。'},
{p:1,t:'面對壓力或衝突時，我能保持冷靜不失衡。'},{p:1,t:'我能有效地釋放累積的負面情緒與雜念。'},
{p:2,t:'我常感覺靈感／情感在體內自然流動。'},{p:2,t:'我能順勢調整步調，不僵硬或卡住。'},
{p:3,t:'做決定時，我能堅定地選擇對自己真的好的事。'},{p:3,t:'遇到挑戰，我仍能相信自己並往前一步。'},
{p:4,t:'我能真誠表達，也樂於傾聽他人。'},{p:4,t:'我能感到自己與他人、與世界是連結的。'},
{p:5,t:'我信任直覺，且能從中獲得有用的指引。'},{p:5,t:'我能從日常事件看見更深的洞見與意義。'},
{p:6,t:'我能把過去的經驗整合成力量，而不是枷鎖。'},{p:6,t:'我常感到自己完整、對生命方向踏實安心。'}
];
const host=document.getElementById('qs');
Q.forEach((q,i)=>{const e=document.createElement('div');e.className='q';e.innerHTML=`<div>${i+1}. <b>${P[q.p].k}｜${P[q.p].n}</b>．${q.t}</div><input type="range" min="0" max="10" step="1" value="5" id="r${i}"><div class="score" id="v${i}">5</div>`;host.appendChild(e);e.querySelector(`#r${i}`).addEventListener('input',ev=>e.querySelector(`#v${i}`).textContent=ev.target.value);});

function avg(){const s=Array(7).fill(0),c=Array(7).fill(0);Q.forEach((q,i)=>{const v=+document.getElementById('r'+i).value;s[q.p]+=v;c[q.p]++});return s.map((x,i)=>c[i]?x/c[i]:0)}
function radar(vals){const cv=document.getElementById('radar'),ctx=cv.getContext('2d'),W=cv.width,H=cv.height,cx=W/2,cy=H/2,R=Math.min(W,H)*0.35;ctx.clearRect(0,0,W,H);ctx.save();ctx.translate(cx,cy);ctx.strokeStyle='#ffffff22';for(let s=1;s<=5;s++){ctx.beginPath();ctx.arc(0,0,R*s/5,0,Math.PI*2);ctx.stroke()}for(let i=0;i<7;i++){const a=-Math.PI/2+i*(Math.PI*2/7);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(Math.cos(a)*R,Math.sin(a)*R);ctx.stroke()}ctx.beginPath();vals.forEach((v,i)=>{const a=-Math.PI/2+i*(Math.PI*2/7),rr=(v/10)*R;const x=Math.cos(a)*rr,y=Math.sin(a)*rr;i?ctx.lineTo(x,y):ctx.moveTo(x,y)});ctx.closePath();ctx.fillStyle='#7c3aed55';ctx.fill();ctx.strokeStyle='#7c3aed';ctx.stroke();ctx.restore();}

function today(){return new Date().toISOString().slice(0,10)}
function pick(a){return a[Math.floor(Math.random()*a.length)]}
async function load(p){const r=await fetch(p);return r.ok? r.json():null}

const K_STREAK='e7_streak', K_TOTAL='e7_total', K_LAST='e7_lastDay', K_UNLOCK='e7_unlocked';
function read(k,d){try{const v=JSON.parse(localStorage.getItem(k));return v??d}catch(_){return d}}
function write(k,v){localStorage.setItem(k,JSON.stringify(v))}
function updateBadges(){const s=read(K_STREAK,0);document.getElementById('streak').textContent=s;document.getElementById('total').textContent=read(K_TOTAL,0);
['b7','b21','b30'].forEach(id=>document.getElementById(id).classList.remove('on')); if(s>=7)document.getElementById('b7').classList.add('on'); if(s>=21)document.getElementById('b21').classList.add('on'); if(s>=30)document.getElementById('b30').classList.add('on');}
async function onDone(){const last=read(K_LAST,''),t=today();let s=read(K_STREAK,0), tot=read(K_TOTAL,0);
 if(last!==t){ s = (last && ((new Date(t)-new Date(last))===86400000)) ? s+1 : 1; tot+=1; write(K_LAST,t); write(K_STREAK,s); write(K_TOTAL,tot); updateBadges();
 let msg='已記錄今天 ✔️'; if(s%7===0){ const deck=await load('hidden_cards.json'); const arr=read(K_UNLOCK,[]); const next=deck.find(c=>!arr.includes(c.id)); if(next){arr.push(next.id); write(K_UNLOCK,arr); msg+=' ｜ 解鎖：'+next.title; renderUnlocked(arr,deck);} }
 document.getElementById('unlock').textContent=msg; }
}
document.getElementById('done').onclick=onDone; updateBadges();

async function renderUnlocked(ids=null, deck=null){ deck=deck || await load('hidden_cards.json'); ids = ids ?? read(K_UNLOCK,[]); const box=document.getElementById('unlocked'); if(!ids.length){box.textContent='尚未解鎖。'; return} box.innerHTML=ids.map(i=>{const c=deck.find(x=>x.id===i); return `<span class='pill'>#${c.id}｜${c.title}</span>`}).join(' ') }

async function showOracle(){ const store='e7_oracle_v70'; const deck=await load('oracle_whispering.json'); const rec=read(store,{}); const t=today(); let card; if(rec.d!==t){ card=pick(deck); write(store,{d:t,id:card.id}); } else { card=deck.find(x=>x.id===rec.id)||deck[0]; } document.getElementById('oracle').innerHTML=`<b>「${card.title}」</b><div class="hint">${card.poem}</div><div>行動：${card.action}</div>` }
async function showOil(force){ const store='e7_oil_v70'; const list=await load('yl_blends.json'); const rec=read(store,{}); const t=today(); let item; if(force||rec.d!==t){ item=pick(list); write(store,{d:t,name:item.name}); } else { item=list.find(x=>x.name===rec.name)||list[0]; } document.getElementById('oil').innerHTML=`<b>${item.name}（${item.zh_name}）</b><div class="hint">${item.description}</div>` }
document.getElementById('draw').onclick=showOracle; document.getElementById('reroll').onclick=()=>showOil(true); showOracle(); showOil(); renderUnlocked();

async function renderStageList(){ const data=await load('stages.json'); const order=['S1','S2','S3','S4','S5','S6','S7']; const box=document.getElementById('stageList'); box.innerHTML=''; order.forEach((k,i)=>{const st=data[k]; const el=document.createElement('div'); el.className='q'; el.innerHTML=`<div><b>${i+1}. ${st.name} (${st.en})</b></div>`+ st.keywords.map(x=>`<span class='pill'>${x}</span>`).join(' ') + `<div class='small'>行動：${st.actions.join('、')}</div>`; box.appendChild(el); }); }
renderStageList();

async function renderLowest(a){ const idx=a.map((v,i)=>[v,i]).sort((x,y)=>x[0]-y[0]).slice(0,2).map(x=>x[1]); const data=await load('stages.json'); const trans=await load('transitions.json'); const order=['S1','S2','S3','S4','S5','S6','S7']; const box=document.getElementById('stageTips'); box.innerHTML='';
 idx.forEach(i=>{ const k=order[i]; const st=data[k]; const tid='T'+(i+1); const t=trans[tid]; const div=document.createElement('div'); div.className='q'; div.innerHTML=`<div><b>${st.name}</b>（${P[i].k}）</div><div class='small'>關鍵字：${st.keywords.join('、')}</div><div>建議：${st.actions.join('、')}</div><div class='small'>${t.title}：${t.tips.join('；')}</div>`; box.appendChild(div); }); document.getElementById('lowestPanel').style.display='block'; }

document.getElementById('go').onclick=()=>{ const a=avg(); const maxI=a.indexOf(Math.max(...a)), minI=a.indexOf(Math.min(...a)); document.getElementById('sum').textContent=`最高：${P[maxI].k} ${a[maxI].toFixed(1)}／最低：${P[minI].k} ${a[minI].toFixed(1)}`; document.getElementById('res').style.display='block'; radar(a); renderLowest(a); };
</script></body></html>
